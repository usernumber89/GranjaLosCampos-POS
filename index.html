<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4CAF50">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Granja Los Campos - Sistema POS</title>
    <link rel="stylesheet" href="styles.css">
    </style>
</head>
<body>
    <!-- Formulario de Login -->
    <div id="loginForm" class="login-container" style="display: none;">
        <div class="login-card">
            <div class="login-header">
                <div class="login-logo">
                    <span class="logo-icon">üêî</span>
                </div>
                <h2>Granja Los Campos</h2>
                <p>Sistema de Punto de Venta</p>
            </div>

            <form class="login-form" onsubmit="handleLoginSubmit(event)">
                <div class="form-group">
                    <label for="loginEmail">Correo Electr√≥nico</label>
                    <div class="input-wrapper">
                        <span class="input-icon">üìß</span>
                        <input
                            type="email"
                            id="loginEmail"
                            placeholder="admin@granja.com"
                            required
                            autocomplete="email"
                            maxlength="100"
                        >
                    </div>
                </div>

                <div class="form-group">
                    <label for="loginPassword">Contrase√±a</label>
                    <div class="input-wrapper">
                        <span class="input-icon">üîí</span>
                        <input
                            type="password"
                            id="loginPassword"
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                            required
                            autocomplete="current-password"
                            minlength="6"
                            maxlength="50"
                        >
                    </div>
                </div>

                <div class="form-options">
                    <label class="checkbox-container">
                        <input type="checkbox" id="rememberMe">
                        <span class="checkmark"></span>
                        Recordarme
                    </label>
                    <a href="#" class="forgot-password" onclick="showForgotPassword()">¬øOlvidaste tu contrase√±a?</a>
                </div>

                <button type="submit" class="btn-login" id="loginButton">
                    <span class="btn-text">üö™ Iniciar Sesi√≥n</span>
                    <div class="btn-spinner" id="loginSpinner" style="display: none;"></div>
                </button>
            </form>

            <div class="login-footer">
                <p>¬øNo tienes acceso? Contacta al administrador</p>
                <div class="security-notice">
                    <span class="security-icon">üõ°Ô∏è</span>
                    <small>Conexi√≥n segura ‚Ä¢ Datos protegidos</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Aplicaci√≥n Principal -->
    <div id="mainApp">
        <div class="container">
        <header>
            <div class="header-content">
                <h1>üêî Granja Los Campos</h1>
                <p>Sistema de punto de venta con Firebase</p>
            </div>
            <div class="header-actions">
                <div class="db-status connected" id="dbStatus">
                    <div class="db-indicator"></div>
                    <span>Base de Datos Conectada</span>
                </div>
                <div id="userInfo" class="user-info"></div>
            </div>
        </header>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab(event,'ventas')">üí∞ Ventas</button>
            <button class="tab" onclick="switchTab(event,'lotes')">üì¶ Lotes</button>
            <button class="tab" onclick="switchTab(event,'clientes')">üë• Clientes</button>
            <button class="tab" onclick="switchTab(event,'proveedores')">üè¢ Proveedores</button>
            <button class="tab" onclick="switchTab(event,'salidas')">üí∏ Salidas</button>
            <button class="tab" onclick="switchTab(event,'reportes')">üìä Reportes</button>
            <button class="tab" onclick="switchTab(event,'database')">üíæ Base de Datos</button>
        </div>
        
        <!-- TAB: VENTAS -->
        <div id="ventas" class="tab-content active">
            <div class="grid">
                <div>
                    <div class="card">
                        <h2>üõí Nueva Venta</h2>
                        
                        <div class="form-group">
                            <label>Cliente</label>
                            <select id="ventaCliente">
                                <option value="">Seleccionar cliente...</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Tipo de Producto</label>
                            <select id="ventaTipoProducto" onchange="actualizarCamposVenta()">
                                <option value="pollo_entero">Pollo Entero</option>
                                <option value="pechuga">Pechuga</option>
                                <option value="entrepierna">Entrepierna</option>
                                <option value="pata">Patas</option>
                                <option value="menudos">Menudos</option>
                                <option value="otros">Otros</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Lote (opcional)</label>
                            <select id="ventaLote" onchange="actualizarInfoLote()">
                                <option value="">Sin lote</option>
                            </select>
                        </div>
                        
                        <div id="infoLote" style="display: none; background: var(--background); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <strong style="color: var(--primary);">Informaci√≥n del Lote</strong>
                            <div style="margin-top: 10px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                                <div>
                                    <small style="color: var(--text-light);">Pollos disponibles</small>
                                    <div id="loteDisponibles" style="font-weight: 600;"></div>
                                </div>
                                <div>
                                    <small style="color: var(--text-light);">Peso promedio</small>
                                    <div id="lotePeso" style="font-weight: 600;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <div class="form-group">
                                <label>Pollos Utilizados</label>
                                <input type="number" id="ventaCantidad" min="0" value="0" step="1">
                                <small style="color: var(--text-light); font-size: 0.85rem;">
                                    (0 para productos sin descontar del inventario)
                                </small>
                            </div>
                            
                            <div class="form-group">
                                <label>Peso en Libras</label>
                                <input type="number" id="ventaPeso" step="0.01" min="0.01" placeholder="Ej: 5.5">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Precio por Libra ($)</label>
                            <input type="number" id="ventaPrecio" step="0.01" min="0.01" value="2.50">
                        </div>
                        
                        <button class="btn-primary" onclick="agregarAlCarrito()" style="width: 100%;">
                            ‚ûï Agregar al Carrito
                        </button>
                    </div>
                </div>
                
                <div>
                    <div class="card">
                        <h2>üõçÔ∏è Carrito</h2>
                        <div id="carritoItems"></div>
                        
                        <div class="cart-total">
                            <h3>TOTAL</h3>
                            <div class="amount" id="carritoTotal">$0.00</div>
                        </div>
                        
                        <div class="btn-group">
                            <button class="btn-outline" onclick="limpiarCarrito()" style="flex: 1;">
                                üóëÔ∏è Limpiar
                            </button>
                            <button class="btn-primary" onclick="finalizarVenta()" style="flex: 2;">
                                ‚úÖ Finalizar Venta
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- TAB: LOTES -->
        <div id="lotes" class="tab-content">
            <div class="card">
                <h2>üì¶ Gesti√≥n de Lotes</h2>
                
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 25px; margin-top: 20px;">
                    <div>
                        <h3 style="margin-bottom: 15px; color: var(--primary);">Agregar Nuevo Lote</h3>
                        
                        <div class="form-group">
                            <label>N√∫mero de Lote</label>
                            <input type="text" id="loteNumero" placeholder="Ej: LOTE-001">
                        </div>
                        
                        <div class="form-group">
                            <label>Cantidad de Pollos</label>
                            <input type="number" id="loteCantidad" min="1">
                        </div>
                        
                        <div class="form-group">
                            <label>Peso Promedio (lbs)</label>
                            <input type="number" id="lotePesoPromedio" step="0.01" min="0.01">
                        </div>
                        
                        <div class="form-group">
                            <label>Fecha de Ingreso</label>
                            <input type="date" id="loteFecha">
                        </div>
                        
                        <div class="form-group">
                            <label>Notas</label>
                            <textarea id="loteNotas" rows="3" placeholder="Informaci√≥n adicional..."></textarea>
                        </div>
                        
                        <button class="btn-primary" onclick="agregarLote()" style="width: 100%;">
                            ‚ûï Agregar Lote
                        </button>
                    </div>
                    
                    <div>
                        <h3 style="margin-bottom: 15px; color: var(--primary);">Lotes Registrados</h3>
                        <div id="listaLotes"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- TAB: CLIENTES -->
        <div id="clientes" class="tab-content">
            <div class="card">
                <h2>üë• Gesti√≥n de Clientes</h2>
                
                <div class="btn-group" style="margin-bottom: 20px;">
                    <div class="file-input-wrapper">
                        <input type="file" id="importarClientes" accept=".xlsx,.xls,.csv" onchange="importarClientesExcel(event)">
                        <label for="importarClientes" class="file-input-label">
                            üì• Importar desde Excel
                        </label>
                    </div>
                    <button class="btn-secondary" onclick="exportarClientesExcel()">
                        üì§ Exportar a Excel
                    </button>
                    <button class="btn-primary" onclick="mostrarFormCliente()">
                        ‚ûï Agregar Cliente
                    </button>
                </div>
                
                <div id="formCliente" style="display: none; background: var(--background); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px; color: var(--primary);">Nuevo Cliente</h3>
                    <div class="form-group">
                        <label>ID del Cliente</label>
                        <input type="text" id="clienteId" readonly style="background: #f0f0f0; cursor: not-allowed;">
                        <small style="color: var(--text-light); font-size: 0.85rem;">
                            (Generado autom√°ticamente)
                        </small>
                    </div>
                    <div class="input-group">
                        <div class="form-group">
                            <label>Nombre</label>
                            <input type="text" id="clienteNombre">
                        </div>
                        <div class="form-group">
                            <label>Tel√©fono</label>
                            <input type="tel" id="clienteTelefono">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Direcci√≥n</label>
                        <input type="text" id="clienteDireccion">
                    </div>
                    <div class="btn-group">
                        <button class="btn-outline" onclick="ocultarFormCliente()">Cancelar</button>
                        <button class="btn-primary" onclick="agregarCliente()">Guardar Cliente</button>
                    </div>
                </div>
                
                <div id="listaClientes"></div>
            </div>
        </div>
        
        <!-- TAB: PROVEEDORES -->
        <div id="proveedores" class="tab-content">
            <div class="card">
                <h2>üè¢ Gesti√≥n de Proveedores</h2>
                
                <div class="btn-group" style="margin-bottom: 20px;">
                    <div class="file-input-wrapper">
                        <input type="file" id="importarProveedores" accept=".xlsx,.xls,.csv" onchange="importarProveedoresExcel(event)">
                        <label for="importarProveedores" class="file-input-label">
                            üì• Importar desde Excel
                        </label>
                    </div>
                    <button class="btn-secondary" onclick="exportarProveedoresExcel()">
                        üì§ Exportar a Excel
                    </button>
                    <button class="btn-primary" onclick="mostrarFormProveedor()">
                        ‚ûï Agregar Proveedor
                    </button>
                </div>
                
                <div id="formProveedor" style="display: none; background: var(--background); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px; color: var(--primary);">Nuevo Proveedor</h3>
                    <div class="input-group">
                        <div class="form-group">
                            <label>Nombre de Empresa</label>
                            <input type="text" id="proveedorNombre">
                        </div>
                        <div class="form-group">
                            <label>Contacto</label>
                            <input type="text" id="proveedorContacto">
                        </div>
                    </div>
                    <div class="input-group">
                        <div class="form-group">
                            <label>Tel√©fono</label>
                            <input type="tel" id="proveedorTelefono">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="proveedorEmail">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Direcci√≥n</label>
                        <input type="text" id="proveedorDireccion">
                    </div>
                    <div class="form-group">
                        <label>Tipo de Servicio/Producto</label>
                        <select id="proveedorTipo">
                            <option>Alimento</option>
                            <option>Medicina</option>
                            <option>Transporte</option>
                            <option>Servicios Veterinarios</option>
                            <option>Equipamiento</option>
                            <option>Otros</option>
                        </select>
                    </div>
                    <div class="btn-group">
                        <button class="btn-outline" onclick="ocultarFormProveedor()">Cancelar</button>
                        <button class="btn-primary" onclick="agregarProveedor()">Guardar Proveedor</button>
                    </div>
                </div>
                
                <div id="listaProveedores"></div>
            </div>
        </div>
        
        <!-- TAB: SALIDAS -->
        <div id="salidas" class="tab-content">
            <div class="card">
                <h2>üí∏ Registro de Salidas / Gastos</h2>

                <div class="input-group">
                    <div class="form-group">
                        <label>Fecha</label>
                        <input type="date" id="salidaFecha">
                    </div>

                    <div class="form-group">
                        <label>Tipo</label>
                        <select id="salidaTipo">
                            <option>Alimento</option>
                            <option>Medicina</option>
                            <option>Transporte</option>
                            <option>Personal</option>
                            <option>Servicios Veterinarios</option>
                            <option>Equipamiento</option>
                            <option>Otros</option>
                        </select>
                    </div>
                </div>

                <div class="input-group">
                    <div class="form-group">
                        <label>Lote (opcional)</label>
                        <select id="salidaLote">
                            <option value="">Sin lote</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Proveedor (opcional)</label>
                        <select id="salidaProveedor">
                            <option value="">Sin proveedor</option>
                        </select>
                    </div>
                </div>

                <div class="input-group">
                    <div class="form-group">
                        <label>Monto ($)</label>
                        <input type="number" id="salidaMonto" step="0.01" min="0.01">
                    </div>

                    <div class="form-group">
                        <label>Descripci√≥n</label>
                        <input type="text" id="salidaDescripcion">
                    </div>
                </div>

                <button class="btn-primary" onclick="agregarSalida()" style="width: 100%;">
                    ‚ûï Registrar Salida
                </button>

                <hr style="margin:20px 0">

                <h3 style="margin-bottom: 15px; color: var(--primary);">Salidas Registradas</h3>
                <button class="btn-secondary" onclick="exportarSalidasExcel()" style="margin-bottom: 20px;">
                    üì§ Exportar a Excel
                </button>

                <div id="listaSalidas"></div>
            </div>
        </div>
        
        <!-- TAB: REPORTES -->
        <div id="reportes" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Ventas</h3>
                    <div class="value" id="statVentas">$0.00</div>
                </div>
                <div class="stat-card">
                    <h3>Pollos Vendidos</h3>
                    <div class="value" id="statPollos">0</div>
                </div>
                <div class="stat-card">
                    <h3>Lotes Activos</h3>
                    <div class="value" id="statLotes">0</div>
                </div>
                <div class="stat-card">
                    <h3>Clientes</h3>
                    <div class="value" id="statClientes">0</div>
                </div>
                <div class="stat-card">
                    <h3>Proveedores</h3>
                    <div class="value" id="statProveedores">0</div>
                </div>
                <div class="stat-card">
                    <h3>Total Salidas</h3>
                    <div class="value" id="statSalidas">$0.00</div>
                </div>
            </div>
            
            <div class="card">
                <h2>üìä Historial de Ventas</h2>
                <button class="btn-secondary" onclick="exportarVentasExcel()" style="margin-bottom: 20px;">
                    üì§ Exportar Ventas a Excel
                </button>
                <div id="historialVentas"></div>
            </div>
            
            <div class="card" style="margin-top: 25px;">
                <h2>üí∏ Historial de Salidas</h2>
                <button class="btn-secondary" onclick="exportarSalidasExcel()" style="margin-bottom: 20px;">
                    üì§ Exportar Salidas a Excel
                </button>
                <div id="historialSalidas"></div>
            </div>
        </div>
        
        <!-- TAB: BASE DE DATOS -->
        <div id="database" class="tab-content">
            <div class="card">
                <h2>üíæ Gesti√≥n de Base de Datos</h2>
                
                <div class="db-info">
                    <strong style="color: var(--primary); display: block; margin-bottom: 10px;">
                        Informaci√≥n de la Base de Datos
                    </strong>
                    <div class="db-info-item">
                        <span>Tipo de Base de Datos:</span>
                        <strong>Firebase Realtime Database (Nube)</strong>
                    </div>
                    <div class="db-info-item">
                        <span>Nombre del Proyecto:</span>
                        <strong id="dbName">Configurar credenciales Firebase</strong>
                    </div>
                    <div class="db-info-item">
                        <span>Versi√≥n:</span>
                        <strong id="dbVersion">Firebase SDK v10.7.0</strong>
                    </div>
                    <div class="db-info-item">
                        <span>Estado:</span>
                        <strong id="dbState" style="color: var(--success);">‚úì Conectada</strong>
                    </div>
                </div>
                
                <div class="db-tools">
                    <h3>üîß Herramientas de Base de Datos</h3>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin-bottom: 10px; font-size: 1rem;">Backup y Restauraci√≥n</h4>
                        <div class="btn-group">
                            <button class="btn-secondary" onclick="exportarBaseDatos()">
                                üíæ Descargar Backup Completo (JSON)
                            </button>
                            <div class="file-input-wrapper">
                                <input type="file" id="importarDB" accept=".json" onchange="importarBaseDatos(event)">
                                <label for="importarDB" class="file-input-label" style="background: var(--accent);">
                                    üì• Restaurar desde Backup
                                </label>
                            </div>
                        </div>
                        <p style="margin-top: 10px; color: var(--text-light); font-size: 0.9rem;">
                            El backup incluye todos los lotes, clientes, proveedores, ventas y salidas registrados
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin-bottom: 10px; font-size: 1rem;">Estad√≠sticas de Almacenamiento</h4>
                        <div class="db-info">
                            <div class="db-info-item">
                                <span>Lotes almacenados:</span>
                                <strong id="dbLotesCount">0</strong>
                            </div>
                            <div class="db-info-item">
                                <span>Clientes almacenados:</span>
                                <strong id="dbClientesCount">0</strong>
                            </div>
                            <div class="db-info-item">
                                <span>Proveedores almacenados:</span>
                                <strong id="dbProveedoresCount">0</strong>
                            </div>
                            <div class="db-info-item">
                                <span>Ventas registradas:</span>
                                <strong id="dbVentasCount">0</strong>
                            </div>
                            <div class="db-info-item">
                                <span>Salidas registradas:</span>
                                <strong id="dbSalidasCount">0</strong>
                            </div>
                        </div>
                        <button class="btn-outline" onclick="actualizarEstadisticasDB()" style="margin-top: 10px;">
                            üîÑ Actualizar Estad√≠sticas
                        </button>
                    </div>
                    
                    <div>
                        <h4 style="margin-bottom: 10px; font-size: 1rem; color: var(--error);">‚ö†Ô∏è Zona de Peligro</h4>
                        <div style="background: #ffebee; padding: 15px; border-radius: 8px; border-left: 4px solid var(--error);">
                            <p style="margin-bottom: 10px; color: #c62828;">
                                <strong>Precauci√≥n:</strong> Esta acci√≥n eliminar√° permanentemente todos los datos
                            </p>
                            <button class="btn-danger" onclick="limpiarBaseDatos()">
                                üóëÔ∏è Eliminar Toda la Base de Datos
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- RECIBO (oculto, se muestra al finalizar venta) -->
    <div id="receipt" style="display: none;">
        <div class="receipt-header">
            <h2>üêî Granja Av√≠cola</h2>
            <p>Recibo de Venta</p>
            <small id="reciboFecha"></small>
        </div>
        
        <div id="reciboDetalles"></div>
        
        <div class="receipt-footer">
            <div class="receipt-total">
                <span>TOTAL:</span>
                <span id="reciboTotal"></span>
            </div>
            <p style="text-align: center; color: var(--text-light); font-size: 0.9rem;">
                ¬°Gracias por su compra!
            </p>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <script>
        // ========================================
        // SISTEMA DE BASE DE DATOS - Firebase Firestore
        // ========================================
        
        // Variables globales
        let db = null;
        let auth;
        let currentUser = null;
        let carrito = [];
        
        // Configuraci√≥n de Firebase
       const firebaseConfig = {
  apiKey: "AIzaSyCTV-miHc-sA9-n1MJjQEfwQSfyNvl9vG0",
  authDomain: "granja-los-campos-pos.firebaseapp.com",
  projectId: "granja-los-campos-pos",
  storageBucket: "granja-los-campos-pos.firebasestorage.app",
  messagingSenderId: "553361614502",
  appId: "1:553361614502:web:8192471c4d88bfe3e9b667",
  measurementId: "G-7SL48RPRSF"
};
        
        // Inicializar Firebase
        function initDB() {
            return new Promise((resolve, reject) => {
                try {
                    // Verificar si Firebase ya est√° inicializado
                    if (!firebase.apps.length) {
                        firebase.initializeApp(firebaseConfig);
                    }

                    // Inicializar servicios
                    db = firebase.firestore();
                    auth = firebase.auth();

                    // Configurar persistencia de autenticaci√≥n
                    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

                    // Listener de estado de autenticaci√≥n
                    auth.onAuthStateChanged((user) => {
                        currentUser = user;
                        updateAuthUI(user);
                        
                        if (user) {
                            console.log('Usuario autenticado:', user.email);
                            document.getElementById('dbStatus').classList.add('connected');
                            // Solo actualizar UI si ya se inicializ√≥ la base de datos
                            if (db) {
                                actualizarUI();
                                actualizarEstadisticasDB();
                            }
                        } else {
                            console.log('Usuario no autenticado');
                            document.getElementById('dbStatus').classList.remove('connected');
                            showLoginForm();
                        }
                    });

                    console.log('Firebase inicializado correctamente');
                    resolve({ db, auth });
                } catch (error) {
                    console.error('Error al inicializar Firebase:', error);
                    document.getElementById('dbStatus').innerHTML = '<div class="db-indicator" style="background: red;"></div><span>Error de Conexi√≥n</span>';
                    reject(error);
                }
            });
        }
        
        // ========================================
        // SISTEMA DE AUTENTICACI√ìN
        // ========================================
        
        async function signIn(email, password) {
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                console.log('Usuario inici√≥ sesi√≥n:', userCredential.user.email);
                return { success: true, user: userCredential.user };
            } catch (error) {
                console.error('Error al iniciar sesi√≥n:', error);
                return { success: false, error: getAuthErrorMessage(error.code) };
            }
        }
        
        async function signOut() {
            try {
                await auth.signOut();
                console.log('Usuario cerr√≥ sesi√≥n');
                return { success: true };
            } catch (error) {
                console.error('Error al cerrar sesi√≥n:', error);
                return { success: false, error: error.message };
            }
        }
        
        function getAuthErrorMessage(errorCode) {
            switch (errorCode) {
                case 'auth/invalid-email':
                    return 'Correo electr√≥nico inv√°lido';
                case 'auth/user-disabled':
                    return 'Usuario deshabilitado';
                case 'auth/user-not-found':
                    return 'Usuario no encontrado';
                case 'auth/wrong-password':
                    return 'Contrase√±a incorrecta';
                case 'auth/email-already-in-use':
                    return 'El correo ya est√° registrado';
                case 'auth/weak-password':
                    return 'La contrase√±a es muy d√©bil (m√≠nimo 6 caracteres)';
                case 'auth/network-request-failed':
                    return 'Error de conexi√≥n';
                case 'auth/too-many-requests':
                    return 'Demasiados intentos, intenta m√°s tarde';
                default:
                    return 'Error de autenticaci√≥n: ' + errorCode;
            }
        }
        
        // ========================================
        // FUNCIONES DE UI DE AUTENTICACI√ìN
        // ========================================
        
        function updateAuthUI(user) {
            const loginForm = document.getElementById('loginForm');
            const mainApp = document.getElementById('mainApp');
            const userInfo = document.getElementById('userInfo');
            
            if (user) {
                // Usuario autenticado
                loginForm.style.display = 'none';
                mainApp.style.display = 'block';
                userInfo.innerHTML = `
                    <span>üë§ ${user.email}</span>
                    <button onclick="handleSignOut()" class="btn-secondary" style="margin-left: 10px; font-size: 0.9rem;">
                        üö™ Cerrar Sesi√≥n
                    </button>
                `;
            } else {
                // Usuario no autenticado
                loginForm.style.display = 'block';
                mainApp.style.display = 'none';
                userInfo.innerHTML = '';
            }
        }
        
        function showLoginForm() {
            const loginForm = document.getElementById('loginForm');
            const mainApp = document.getElementById('mainApp');
            
            loginForm.style.display = 'block';
            mainApp.style.display = 'none';
        }
        
        async function handleLoginSubmit(event) {
            event.preventDefault();
            
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const rememberMe = document.getElementById('rememberMe').checked;
            const loginButton = document.getElementById('loginButton');
            const loginSpinner = document.getElementById('loginSpinner');
            const btnText = loginButton.querySelector('.btn-text');
            
            // Validaciones de seguridad
            if (!validateEmail(email)) {
                showLoginError('Por favor ingresa un correo electr√≥nico v√°lido');
                return;
            }
            
            if (!validatePassword(password)) {
                showLoginError('La contrase√±a debe tener al menos 6 caracteres');
                return;
            }
            
            // Cambiar estado del bot√≥n
            loginButton.disabled = true;
            btnText.style.display = 'none';
            loginSpinner.style.display = 'block';
            
            try {
                const result = await signIn(email, password);
                
                if (result.success) {
                    // Configurar persistencia si se seleccion√≥ "recordarme"
                    if (rememberMe) {
                        await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                    } else {
                        await auth.setPersistence(firebase.auth.Auth.Persistence.SESSION);
                    }
                    
                    hideLoginError();
                    mostrarAlerta('¬°Bienvenido a Granja Los Campos!', 'success');
                } else {
                    showLoginError(result.error);
                }
            } catch (error) {
                showLoginError('Error de conexi√≥n. Intenta nuevamente.');
            } finally {
                // Restaurar estado del bot√≥n
                loginButton.disabled = false;
                btnText.style.display = 'inline';
                loginSpinner.style.display = 'none';
            }
        }
        
        async function handleSignOut() {
            const result = await signOut();
            
            if (result.success) {
                mostrarAlerta('Sesi√≥n cerrada correctamente', 'success');
            } else {
                mostrarAlerta('Error al cerrar sesi√≥n: ' + result.error, 'error');
            }
        }
        
        function showLoginError(message) {
            const errorDiv = document.querySelector('.error-message') || createErrorDiv();
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            // Agregar animaci√≥n de shake
            const loginCard = document.querySelector('.login-card');
            loginCard.style.animation = 'shake 0.5s ease-in-out';
            setTimeout(() => {
                loginCard.style.animation = '';
            }, 500);
        }
        
        function hideLoginError() {
            const errorDiv = document.querySelector('.error-message');
            if (errorDiv) {
                errorDiv.style.display = 'none';
            }
        }
        
        function createErrorDiv() {
            const loginForm = document.querySelector('.login-form');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            loginForm.insertBefore(errorDiv, loginForm.firstChild);
            return errorDiv;
        }
        
        function validateEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email) && email.length <= 100;
        }
        
        function validatePassword(password) {
            return password.length >= 6 && password.length <= 50;
        }
        
        function showForgotPassword() {
            const email = document.getElementById('loginEmail').value.trim();
            if (!email) {
                showLoginError('Ingresa tu correo electr√≥nico primero');
                return;
            }
            
            if (!validateEmail(email)) {
                showLoginError('Ingresa un correo electr√≥nico v√°lido');
                return;
            }
            
            // Enviar email de recuperaci√≥n
            auth.sendPasswordResetEmail(email)
                .then(() => {
                    mostrarAlerta('Se ha enviado un enlace de recuperaci√≥n a tu correo', 'success');
                })
                .catch((error) => {
                    console.error('Error al enviar recuperaci√≥n:', error);
                    showLoginError('Error al enviar el email de recuperaci√≥n');
                });
        }
        
        // Funciones CRUD gen√©ricas para Firebase Firestore
        function agregarRegistro(storeName, data) {
            return new Promise((resolve, reject) => {
                const docRef = db.collection(storeName).doc();
                data.id = docRef.id; // Firestore usa IDs de documento

                docRef.set(data)
                    .then(() => {
                        resolve(docRef.id);
                    })
                    .catch((error) => {
                        reject(error);
                    });
            });
        }
        
        function obtenerRegistro(storeName, id) {
            return new Promise((resolve, reject) => {
                db.collection(storeName).doc(id).get()
                    .then((doc) => {
                        if (doc.exists) {
                            const data = doc.data();
                            data.id = doc.id;
                            resolve(data);
                        } else {
                            resolve(null);
                        }
                    })
                    .catch((error) => {
                        reject(error);
                    });
            });
        }
        
        function obtenerTodos(storeName) {
            return new Promise((resolve, reject) => {
                db.collection(storeName).get()
                    .then((querySnapshot) => {
                        const datos = [];
                        querySnapshot.forEach((doc) => {
                            const data = doc.data();
                            data.id = doc.id;
                            datos.push(data);
                        });
                        resolve(datos);
                    })
                    .catch((error) => {
                        reject(error);
                    });
            });
        }
        
        function actualizarRegistro(storeName, data) {
            return new Promise((resolve, reject) => {
                const id = data.id;
                const dataCopy = { ...data };
                delete dataCopy.id;

                db.collection(storeName).doc(id).set(dataCopy)
                    .then(() => {
                        resolve(id);
                    })
                    .catch((error) => {
                        reject(error);
                    });
            });
        }
        
        function eliminarRegistro(storeName, id) {
            return new Promise((resolve, reject) => {
                db.collection(storeName).doc(id).delete()
                    .then(() => {
                        resolve();
                    })
                    .catch((error) => {
                        reject(error);
                    });
            });
        }
        
        function limpiarStore(storeName) {
            return new Promise((resolve, reject) => {
                // Obtener todos los documentos de la colecci√≥n
                db.collection(storeName).get()
                    .then((querySnapshot) => {
                        const batch = db.batch();
                        querySnapshot.forEach((doc) => {
                            batch.delete(doc.ref);
                        });
                        return batch.commit();
                    })
                    .then(() => {
                        resolve();
                    })
                    .catch((error) => {
                        reject(error);
                    });
            });
        }
        
        // ========================================
        // GESTI√ìN DE LOTES
        // ========================================
        
        async function agregarLote() {
            const numero = document.getElementById('loteNumero').value;
            const cantidad = parseInt(document.getElementById('loteCantidad').value);
            const peso = parseFloat(document.getElementById('lotePesoPromedio').value);
            const fecha = document.getElementById('loteFecha').value;
            const notas = document.getElementById('loteNotas').value;
            
            if (!numero || !cantidad || !peso || !fecha) {
                alert('Por favor complete todos los campos obligatorios');
                return;
            }
            
            const lote = {
                id: Date.now(),
                numero,
                cantidad,
                disponibles: cantidad,
                pesoPromedio: peso,
                fecha,
                notas,
                activo: true
            };
            
            try {
                await agregarRegistro('lotes', lote);
                
                // Limpiar formulario
                document.getElementById('loteNumero').value = '';
                document.getElementById('loteCantidad').value = '';
                document.getElementById('lotePesoPromedio').value = '';
                document.getElementById('loteFecha').value = '';
                document.getElementById('loteNotas').value = '';
                
                mostrarAlerta('Lote agregado exitosamente a la base de datos', 'success');
                await actualizarUI();
            } catch (error) {
                console.error('Error al agregar lote:', error);
                mostrarAlerta('Error al guardar el lote', 'error');
            }
        }
        
        async function eliminarLote(id) {
            if (confirm('¬øEst√° seguro de eliminar este lote de la base de datos?')) {
                try {
                    await eliminarRegistro('lotes', id);
                    mostrarAlerta('Lote eliminado', 'success');
                    await actualizarUI();
                } catch (error) {
                    console.error('Error al eliminar lote:', error);
                    mostrarAlerta('Error al eliminar el lote', 'error');
                }
            }
        }
        
        async function renderizarLotes() {
            const container = document.getElementById('listaLotes');
            const lotes = await obtenerTodos('lotes');
            
            // Actualizar select de salidas
            const selectSalida = document.getElementById('salidaLote');
            if (selectSalida) {
                selectSalida.innerHTML = '<option value="">Sin lote</option>';
                lotes.forEach(l => {
                    selectSalida.innerHTML += `<option value="${l.id}">${l.numero}</option>`;
                });
            }
            
            if (lotes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>No hay lotes en la base de datos</p>
                    </div>
                `;
                return;
            }
            
            let html = '<table><thead><tr><th>Lote</th><th>Pollos</th><th>Peso Prom.</th><th>Fecha</th><th>Estado</th><th>Acciones</th></tr></thead><tbody>';
            
            lotes.forEach(lote => {
                html += `
                    <tr>
                        <td><strong>${lote.numero}</strong></td>
                        <td>${lote.disponibles} / ${lote.cantidad}</td>
                        <td>${lote.pesoPromedio} lbs</td>
                        <td>${new Date(lote.fecha).toLocaleDateString()}</td>
                        <td><span class="badge ${lote.activo ? 'badge-active' : 'badge-inactive'}">${lote.activo ? 'Activo' : 'Agotado'}</span></td>
                        <td>
                            <button class="btn-outline action-btn" onclick="eliminarLote(${lote.id})">Eliminar</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
            
            // Actualizar select de ventas
            const select = document.getElementById('ventaLote');
            select.innerHTML = '<option value="">Seleccionar lote...</option>';
            lotes.filter(l => l.activo && l.disponibles > 0).forEach(lote => {
                select.innerHTML += `<option value="${lote.id}">${lote.numero} (${lote.disponibles} disponibles)</option>`;
            });
        }
        
        async function actualizarInfoLote() {
            const loteId = parseInt(document.getElementById('ventaLote').value);
            const infoDiv = document.getElementById('infoLote');
            
            if (!loteId) {
                infoDiv.style.display = 'none';
                return;
            }
            
            const lote = await obtenerRegistro('lotes', loteId);
            if (lote) {
                document.getElementById('loteDisponibles').textContent = `${lote.disponibles} pollos`;
                document.getElementById('lotePeso').textContent = `${lote.pesoPromedio} lbs`;
                infoDiv.style.display = 'block';
            }
        }
        
        function actualizarCamposVenta() {
            const tipoProducto = document.getElementById('ventaTipoProducto').value;
            const cantidadInput = document.getElementById('ventaCantidad');
            
            // Sugerir valores por defecto seg√∫n el tipo de producto
            if (tipoProducto === 'pollo_entero') {
                cantidadInput.value = '1';
            } else {
                cantidadInput.value = '0';
            }
        }
        
        // ========================================
        // GESTI√ìN DE CLIENTES
        // ========================================
        
        async function generarIdCliente() {
            const clientes = await obtenerTodos('clientes');
            
            // Encontrar el n√∫mero m√°s alto
            let maxNum = 0;
            clientes.forEach(cliente => {
                if (cliente.clienteId && cliente.clienteId.startsWith('CLI-')) {
                    const num = parseInt(cliente.clienteId.split('-')[1]);
                    if (!isNaN(num) && num > maxNum) {
                        maxNum = num;
                    }
                }
            });
            
            // Generar nuevo ID
            const nuevoNum = maxNum + 1;
            return `CLI-${nuevoNum.toString().padStart(4, '0')}`;
        }
        
        async function mostrarFormCliente() {
            document.getElementById('formCliente').style.display = 'block';
            
            // Generar y mostrar ID autom√°tico
            const nuevoId = await generarIdCliente();
            document.getElementById('clienteId').value = nuevoId;
        }
        
        function ocultarFormCliente() {
            document.getElementById('formCliente').style.display = 'none';
            document.getElementById('clienteId').value = '';
            document.getElementById('clienteNombre').value = '';
            document.getElementById('clienteTelefono').value = '';
            document.getElementById('clienteDireccion').value = '';
        }
        
        async function agregarCliente() {
            const clienteId = document.getElementById('clienteId').value;
            const nombre = document.getElementById('clienteNombre').value;
            const telefono = document.getElementById('clienteTelefono').value;
            const direccion = document.getElementById('clienteDireccion').value;
            
            if (!nombre) {
                alert('El nombre es obligatorio');
                return;
            }
            
            const cliente = {
                id: Date.now(),
                clienteId: clienteId,
                nombre,
                telefono,
                direccion
            };
            
            try {
                await agregarRegistro('clientes', cliente);
                ocultarFormCliente();
                mostrarAlerta(`Cliente agregado con ID: ${clienteId}`, 'success');
                await actualizarUI();
            } catch (error) {
                console.error('Error al agregar cliente:', error);
                mostrarAlerta('Error al guardar el cliente', 'error');
            }
        }
        
        async function eliminarCliente(id) {
            if (confirm('¬øEst√° seguro de eliminar este cliente?')) {
                try {
                    await eliminarRegistro('clientes', id);
                    mostrarAlerta('Cliente eliminado', 'success');
                    await actualizarUI();
                } catch (error) {
                    console.error('Error al eliminar cliente:', error);
                    mostrarAlerta('Error al eliminar el cliente', 'error');
                }
            }
        }
        
        async function renderizarClientes() {
            const container = document.getElementById('listaClientes');
            const clientes = await obtenerTodos('clientes');
            
            if (clientes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>No hay clientes en la base de datos</p>
                        <p style="font-size: 0.9rem;">Agregue clientes manualmente o importe desde Excel</p>
                    </div>
                `;
                return;
            }
            
            let html = '<table><thead><tr><th>ID Cliente</th><th>Nombre</th><th>Tel√©fono</th><th>Direcci√≥n</th><th>Acciones</th></tr></thead><tbody>';
            
            clientes.forEach(cliente => {
                const clienteId = cliente.clienteId || '-';
                html += `
                    <tr>
                        <td><span class="badge badge-active">${clienteId}</span></td>
                        <td><strong>${cliente.nombre}</strong></td>
                        <td>${cliente.telefono || '-'}</td>
                        <td>${cliente.direccion || '-'}</td>
                        <td>
                            <button class="btn-outline action-btn" onclick="eliminarCliente(${cliente.id})">Eliminar</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
            
            // Actualizar select de ventas
            const select = document.getElementById('ventaCliente');
            select.innerHTML = '<option value="">Seleccionar cliente...</option>';
            clientes.forEach(cliente => {
                const displayText = cliente.clienteId 
                    ? `${cliente.clienteId} - ${cliente.nombre}` 
                    : cliente.nombre;
                select.innerHTML += `<option value="${cliente.id}">${displayText}</option>`;
            });
        }
        
        async function importarClientesExcel(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(firstSheet);
                    
                    let importados = 0;
                    const clientes = await obtenerTodos('clientes');
                    
                    // Encontrar el n√∫mero m√°s alto existente
                    let maxNum = 0;
                    clientes.forEach(cliente => {
                        if (cliente.clienteId && cliente.clienteId.startsWith('CLI-')) {
                            const num = parseInt(cliente.clienteId.split('-')[1]);
                            if (!isNaN(num) && num > maxNum) {
                                maxNum = num;
                            }
                        }
                    });
                    
                    for (const row of rows) {
                        if (row.Nombre || row.nombre) {
                            maxNum++;
                            const nuevoId = `CLI-${maxNum.toString().padStart(4, '0')}`;
                            
                            const cliente = {
                                id: Date.now() + Math.random() * 1000,
                                clienteId: nuevoId,
                                nombre: row.Nombre || row.nombre || '',
                                telefono: row.Telefono || row.telefono || row.Tel√©fono || '',
                                direccion: row.Direccion || row.direccion || row.Direcci√≥n || ''
                            };
                            await agregarRegistro('clientes', cliente);
                            importados++;
                        }
                    }
                    
                    mostrarAlerta(`${importados} clientes importados a la base de datos`, 'success');
                    await actualizarUI();
                } catch (error) {
                    console.error('Error al importar:', error);
                    alert('Error al importar el archivo. Verifique que sea un archivo Excel v√°lido.');
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        async function exportarClientesExcel() {
            const clientes = await obtenerTodos('clientes');
            
            if (clientes.length === 0) {
                alert('No hay clientes para exportar');
                return;
            }
            
            const data = clientes.map(c => ({
                'ID Cliente': c.clienteId || '-',
                Nombre: c.nombre,
                Tel√©fono: c.telefono || '',
                Direcci√≥n: c.direccion || ''
            }));
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Clientes");
            XLSX.writeFile(wb, `clientes_${new Date().toISOString().split('T')[0]}.xlsx`);
        }
        
        // ========================================
        // GESTI√ìN DE PROVEEDORES
        // ========================================
        
        function mostrarFormProveedor() {
            document.getElementById('formProveedor').style.display = 'block';
        }
        
        function ocultarFormProveedor() {
            document.getElementById('formProveedor').style.display = 'none';
            document.getElementById('proveedorNombre').value = '';
            document.getElementById('proveedorContacto').value = '';
            document.getElementById('proveedorTelefono').value = '';
            document.getElementById('proveedorEmail').value = '';
            document.getElementById('proveedorDireccion').value = '';
            document.getElementById('proveedorTipo').value = 'Alimento';
        }
        
        async function agregarProveedor() {
            const nombre = document.getElementById('proveedorNombre').value;
            const contacto = document.getElementById('proveedorContacto').value;
            const telefono = document.getElementById('proveedorTelefono').value;
            const email = document.getElementById('proveedorEmail').value;
            const direccion = document.getElementById('proveedorDireccion').value;
            const tipo = document.getElementById('proveedorTipo').value;
            
            if (!nombre) {
                alert('El nombre de la empresa es obligatorio');
                return;
            }
            
            const proveedor = {
                id: Date.now(),
                nombre,
                contacto,
                telefono,
                email,
                direccion,
                tipo
            };
            
            try {
                await agregarRegistro('proveedores', proveedor);
                ocultarFormProveedor();
                mostrarAlerta('Proveedor agregado a la base de datos', 'success');
                await actualizarUI();
            } catch (error) {
                console.error('Error al agregar proveedor:', error);
                mostrarAlerta('Error al guardar el proveedor', 'error');
            }
        }
        
        async function eliminarProveedor(id) {
            if (confirm('¬øEst√° seguro de eliminar este proveedor?')) {
                try {
                    await eliminarRegistro('proveedores', id);
                    mostrarAlerta('Proveedor eliminado', 'success');
                    await actualizarUI();
                } catch (error) {
                    console.error('Error al eliminar proveedor:', error);
                    mostrarAlerta('Error al eliminar el proveedor', 'error');
                }
            }
        }
        
        async function renderizarProveedores() {
            const container = document.getElementById('listaProveedores');
            const proveedores = await obtenerTodos('proveedores');
            
            if (proveedores.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>No hay proveedores en la base de datos</p>
                        <p style="font-size: 0.9rem;">Agregue proveedores manualmente o importe desde Excel</p>
                    </div>
                `;
            } else {
                let html = '<table><thead><tr><th>Empresa</th><th>Contacto</th><th>Tel√©fono</th><th>Email</th><th>Tipo</th><th>Acciones</th></tr></thead><tbody>';
                
                proveedores.forEach(proveedor => {
                    html += `
                        <tr>
                            <td><strong>${proveedor.nombre}</strong></td>
                            <td>${proveedor.contacto || '-'}</td>
                            <td>${proveedor.telefono || '-'}</td>
                            <td>${proveedor.email || '-'}</td>
                            <td><span class="badge badge-active">${proveedor.tipo}</span></td>
                            <td>
                                <button class="btn-outline action-btn" onclick="eliminarProveedor(${proveedor.id})">Eliminar</button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
            }
            
            // Actualizar select de salidas
            const select = document.getElementById('salidaProveedor');
            if (select) {
                select.innerHTML = '<option value="">Sin proveedor</option>';
                proveedores.forEach(proveedor => {
                    select.innerHTML += `<option value="${proveedor.id}">${proveedor.nombre} (${proveedor.tipo})</option>`;
                });
            }
        }
        
        async function importarProveedoresExcel(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(firstSheet);
                    
                    let importados = 0;
                    for (const row of rows) {
                        if (row.Nombre || row.nombre || row.Empresa || row.empresa) {
                            const proveedor = {
                                id: Date.now() + Math.random() * 1000,
                                nombre: row.Nombre || row.nombre || row.Empresa || row.empresa || '',
                                contacto: row.Contacto || row.contacto || '',
                                telefono: row.Telefono || row.telefono || row.Tel√©fono || '',
                                email: row.Email || row.email || row.Correo || row.correo || '',
                                direccion: row.Direccion || row.direccion || row.Direcci√≥n || '',
                                tipo: row.Tipo || row.tipo || 'Otros'
                            };
                            await agregarRegistro('proveedores', proveedor);
                            importados++;
                        }
                    }
                    
                    mostrarAlerta(`${importados} proveedores importados a la base de datos`, 'success');
                    await actualizarUI();
                } catch (error) {
                    console.error('Error al importar:', error);
                    alert('Error al importar el archivo. Verifique que sea un archivo Excel v√°lido.');
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        async function exportarProveedoresExcel() {
            const proveedores = await obtenerTodos('proveedores');
            
            if (proveedores.length === 0) {
                alert('No hay proveedores para exportar');
                return;
            }
            
            const data = proveedores.map(p => ({
                Empresa: p.nombre,
                Contacto: p.contacto || '',
                Tel√©fono: p.telefono || '',
                Email: p.email || '',
                Direcci√≥n: p.direccion || '',
                Tipo: p.tipo
            }));
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Proveedores");
            XLSX.writeFile(wb, `proveedores_${new Date().toISOString().split('T')[0]}.xlsx`);
        }
        
        // ========================================
        // GESTI√ìN DE SALIDAS
        // ========================================
        
        async function agregarSalida() {
            const fecha = document.getElementById('salidaFecha').value;
            const tipo = document.getElementById('salidaTipo').value;
            const loteId = document.getElementById('salidaLote').value || null;
            const proveedorId = document.getElementById('salidaProveedor').value || null;
            const monto = parseFloat(document.getElementById('salidaMonto').value);
            const descripcion = document.getElementById('salidaDescripcion').value;

            if (!fecha || !monto || monto <= 0) {
                alert('Complete fecha y monto v√°lido');
                return;
            }

            const salida = {
                id: Date.now() + Math.random(),
                fecha,
                tipo,
                loteId,
                proveedorId,
                monto,
                descripcion
            };

            try {
                await agregarRegistro('salidas', salida);

                document.getElementById('salidaMonto').value = '';
                document.getElementById('salidaDescripcion').value = '';

                mostrarAlerta('Salida registrada', 'success');
                await renderizarSalidas();
                await renderizarReportes();
            } catch (error) {
                console.error('Error al registrar salida:', error);
                mostrarAlerta('Error al registrar la salida', 'error');
            }
        }
        
        async function eliminarSalida(id) {
            if (!confirm('¬øEliminar esta salida?')) return;

            try {
                await eliminarRegistro('salidas', id);
                await renderizarSalidas();
                await renderizarReportes();
                await actualizarEstadisticasDB();
                mostrarAlerta('Salida eliminada', 'success');
            } catch (error) {
                console.error('Error al eliminar salida:', error);
                mostrarAlerta('Error al eliminar la salida', 'error');
            }
        }
        
        async function renderizarSalidas() {
            const cont = document.getElementById('listaSalidas');
            const contHistorial = document.getElementById('historialSalidas');
            const salidas = await obtenerTodos('salidas');
            const lotes = await obtenerTodos('lotes');
            const proveedores = await obtenerTodos('proveedores');

            if (salidas.length === 0) {
                const emptyHTML = `<div class="empty-state"><p>No hay salidas registradas</p></div>`;
                if (cont) cont.innerHTML = emptyHTML;
                if (contHistorial) contHistorial.innerHTML = emptyHTML;
                return;
            }

            let html = `<table>
                <thead>
                    <tr>
                        <th>Fecha</th><th>Tipo</th><th>Lote</th><th>Proveedor</th><th>Monto</th><th>Descripci√≥n</th><th>Acciones</th>
                    </tr>
                </thead><tbody>`;

            salidas.slice().reverse().forEach(s => {
                const lote = lotes.find(l => l.id == s.loteId);
                const proveedor = proveedores.find(p => p.id == s.proveedorId);
                html += `
                <tr>
                    <td>${s.fecha}</td>
                    <td>${s.tipo}</td>
                    <td>${lote ? lote.numero : '-'}</td>
                    <td>${proveedor ? proveedor.nombre : '-'}</td>
                    <td>$${s.monto.toFixed(2)}</td>
                    <td>${s.descripcion || ''}</td>
                    <td>
                        <button class="btn-outline action-btn" onclick='eliminarSalida(${JSON.stringify(s.id)})'>
                            Eliminar
                        </button>
                    </td>
                </tr>`;
            });

            html += '</tbody></table>';
            if (cont) cont.innerHTML = html;
            if (contHistorial) contHistorial.innerHTML = html;
        }

        async function exportarSalidasExcel() {
            const salidas = await obtenerTodos('salidas');
            const lotes = await obtenerTodos('lotes');
            const proveedores = await obtenerTodos('proveedores');

            if (salidas.length === 0) {
                alert('No hay salidas para exportar');
                return;
            }

            const data = salidas.map(s => {
                const lote = lotes.find(l => l.id == s.loteId);
                const proveedor = proveedores.find(p => p.id == s.proveedorId);
                return {
                    Fecha: s.fecha,
                    Tipo: s.tipo,
                    Lote: lote ? lote.numero : '',
                    Proveedor: proveedor ? proveedor.nombre : '',
                    Monto: s.monto,
                    Descripcion: s.descripcion || ''
                };
            });

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Salidas');
            XLSX.writeFile(wb, `salidas_${new Date().toISOString().split('T')[0]}.xlsx`);
        }
        
        // ========================================
        // CARRITO Y VENTAS
        // ========================================
        
        async function agregarAlCarrito() {
            const clienteId = parseInt(document.getElementById('ventaCliente').value);
            const tipoProducto = document.getElementById('ventaTipoProducto').value;
            const loteId = parseInt(document.getElementById('ventaLote').value) || null;
            const cantidad = parseInt(document.getElementById('ventaCantidad').value);
            const peso = parseFloat(document.getElementById('ventaPeso').value);
            const precio = parseFloat(document.getElementById('ventaPrecio').value);
            
            if (!clienteId || !peso || !precio) {
                alert('Por favor complete cliente, peso y precio');
                return;
            }
            
            // Validar que si se ingresa cantidad de pollos, haya un lote seleccionado
            if (cantidad > 0 && !loteId) {
                alert('Debe seleccionar un lote si va a descontar pollos del inventario');
                return;
            }
            
            // Validar disponibilidad si se van a descontar pollos
            if (cantidad > 0 && loteId) {
                const lote = await obtenerRegistro('lotes', loteId);
                if (!lote || lote.disponibles < cantidad) {
                    alert('No hay suficientes pollos disponibles en este lote');
                    return;
                }
            }
            
            const cliente = await obtenerRegistro('clientes', clienteId);
            const subtotal = peso * precio;
            
            // Obtener nombre del lote si existe
            let loteNumero = 'Sin lote';
            if (loteId) {
                const lote = await obtenerRegistro('lotes', loteId);
                loteNumero = lote ? lote.numero : 'Sin lote';
            }
            
            // Mapear tipo de producto a nombre legible
            const nombresTipoProducto = {
                'pollo_entero': 'Pollo Entero',
                'pechuga': 'Pechuga',
                'entrepierna': 'Entrepierna',
                'pata': 'Patas',
                'menudos': 'Menudos',
                'otros': 'Otros'
            };
            
            const item = {
                id: Date.now(),
                clienteId,
                clienteNombre: cliente.nombre,
                tipoProducto: nombresTipoProducto[tipoProducto],
                loteId,
                loteNumero,
                cantidad,
                peso,
                precio,
                subtotal
            };
            
            carrito.push(item);
            renderizarCarrito();
            
            // Limpiar campos
            document.getElementById('ventaCantidad').value = '0';
            document.getElementById('ventaPeso').value = '';
        }
        
        function renderizarCarrito() {
            const container = document.getElementById('carritoItems');
            
            if (carrito.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>Carrito vac√≠o</p>
                    </div>
                `;
                document.getElementById('carritoTotal').textContent = '$0.00';
                return;
            }
            
            let html = '';
            let total = 0;
            
            carrito.forEach(item => {
                const infoPollos = item.cantidad > 0 
                    ? `${item.cantidad} pollos √ó ` 
                    : '';
                
                html += `
                    <div class="cart-item">
                        <div class="cart-item-info">
                            <strong>${item.tipoProducto}</strong>
                            <small>${infoPollos}${item.peso} lbs √ó $${item.precio}/lb</small>
                            <small style="display: block; margin-top: 5px;">
                                Cliente: ${item.clienteNombre} | Lote: ${item.loteNumero}
                            </small>
                        </div>
                        <div class="cart-item-price">$${item.subtotal.toFixed(2)}</div>
                    </div>
                `;
                total += item.subtotal;
            });
            
            container.innerHTML = html;
            document.getElementById('carritoTotal').textContent = `$${total.toFixed(2)}`;
        }
        
        function limpiarCarrito() {
            if (carrito.length > 0 && confirm('¬øLimpiar el carrito?')) {
                carrito = [];
                renderizarCarrito();
            }
        }
        
        async function finalizarVenta() {
            if (carrito.length === 0) {
                alert('El carrito est√° vac√≠o');
                return;
            }
            
            try {
                // Crear venta
                const venta = {
                    id: Date.now(),
                    fecha: new Date().toISOString(),
                    items: [...carrito],
                    total: carrito.reduce((sum, item) => sum + item.subtotal, 0)
                };
                
                // Guardar en base de datos
                await agregarRegistro('ventas', venta);
                
                // Actualizar disponibilidad de lotes SOLO si se usaron pollos (cantidad > 0)
                for (const item of carrito) {
                    if (item.cantidad > 0 && item.loteId) {
                        const lote = await obtenerRegistro('lotes', item.loteId);
                        if (lote) {
                            lote.disponibles -= item.cantidad;
                            if (lote.disponibles <= 0) {
                                lote.activo = false;
                            }
                            await actualizarRegistro('lotes', lote);
                        }
                    }
                }
                
                // Mostrar recibo
                mostrarRecibo(venta);
                
                // Limpiar carrito
                carrito = [];
                
                mostrarAlerta('Venta registrada en la base de datos', 'success');
                await actualizarUI();
            } catch (error) {
                console.error('Error al finalizar venta:', error);
                mostrarAlerta('Error al procesar la venta', 'error');
            }
        }
        
        function mostrarRecibo(venta) {
            const receipt = document.getElementById('receipt');
            const detalles = document.getElementById('reciboDetalles');
            
            document.getElementById('reciboFecha').textContent = new Date(venta.fecha).toLocaleString();
            
            let html = '';
            venta.items.forEach(item => {
                const infoPollos = item.cantidad > 0 ? `${item.cantidad} pollos √ó ` : '';
                
                html += `
                    <div class="receipt-item">
                        <div>
                            <strong>${item.tipoProducto}</strong><br>
                            <small>${item.clienteNombre}</small><br>
                            <small>${infoPollos}${item.peso} lbs √ó $${item.precio}/lb</small><br>
                            <small>Lote: ${item.loteNumero}</small>
                        </div>
                        <div><strong>$${item.subtotal.toFixed(2)}</strong></div>
                    </div>
                `;
            });
            
            detalles.innerHTML = html;
            document.getElementById('reciboTotal').textContent = `$${venta.total.toFixed(2)}`;
            
            receipt.style.display = 'block';
            
            if (confirm('¬øDesea imprimir el recibo?')) {
                window.print();
            }
            
            setTimeout(() => {
                receipt.style.display = 'none';
            }, 500);
        }
        
        // ========================================
        // REPORTES
        // ========================================
        
        async function renderizarReportes() {
            const ventas = await obtenerTodos('ventas');
            const lotes = await obtenerTodos('lotes');
            const clientes = await obtenerTodos('clientes');
            const proveedores = await obtenerTodos('proveedores');
            const salidas = await obtenerTodos('salidas');
            
            // Estad√≠sticas
            const totalVentas = ventas.reduce((sum, v) => sum + v.total, 0);
            const totalPollos = ventas.reduce((sum, v) => {
                return sum + v.items.reduce((s, i) => s + i.cantidad, 0);
            }, 0);
            const lotesActivos = lotes.filter(l => l.activo).length;
            const totalSalidas = salidas.reduce((sum, s) => sum + s.monto, 0);
            
            document.getElementById('statVentas').textContent = `$${totalVentas.toFixed(2)}`;
            document.getElementById('statPollos').textContent = totalPollos;
            document.getElementById('statLotes').textContent = lotesActivos;
            document.getElementById('statClientes').textContent = clientes.length;
            document.getElementById('statProveedores').textContent = proveedores.length;
            document.getElementById('statSalidas').textContent = `$${totalSalidas.toFixed(2)}`;
            
            // Historial de ventas
            const containerVentas = document.getElementById('historialVentas');
            
            if (ventas.length === 0) {
                containerVentas.innerHTML = `
                    <div class="empty-state">
                        <p>No hay ventas registradas en la base de datos</p>
                    </div>
                `;
            } else {
                let html = '<table><thead><tr><th>Fecha</th><th>Cliente</th><th>Producto</th><th>Lote</th><th>Pollos</th><th>Peso</th><th>Total</th></tr></thead><tbody>';
                
                ventas.slice().reverse().forEach(venta => {
                    venta.items.forEach(item => {
                        // Mostrar tipo de producto, si no existe usar loteNumero (retrocompatibilidad)
                        const producto = item.tipoProducto || 'Pollo Entero';
                        const pollosInfo = item.cantidad > 0 ? `${item.cantidad} pollos` : '-';
                        
                        html += `
                            <tr>
                                <td>${new Date(venta.fecha).toLocaleString()}</td>
                                <td>${item.clienteNombre}</td>
                                <td>${producto}</td>
                                <td>${item.loteNumero}</td>
                                <td>${pollosInfo}</td>
                                <td>${item.peso} lbs</td>
                                <td><strong>$${item.subtotal.toFixed(2)}</strong></td>
                            </tr>
                        `;
                    });
                });
                
                html += '</tbody></table>';
                containerVentas.innerHTML = html;
            }
            
            // Renderizar salidas en reportes
            await renderizarSalidas();
        }
        
        async function exportarVentasExcel() {
            const ventas = await obtenerTodos('ventas');
            
            if (ventas.length === 0) {
                alert('No hay ventas para exportar');
                return;
            }
            
            const data = [];
            ventas.forEach(venta => {
                venta.items.forEach(item => {
                    const producto = item.tipoProducto || 'Pollo Entero';
                    const pollos = item.cantidad > 0 ? item.cantidad : 0;
                    
                    data.push({
                        Fecha: new Date(venta.fecha).toLocaleString(),
                        Cliente: item.clienteNombre,
                        Producto: producto,
                        Lote: item.loteNumero,
                        'Pollos Utilizados': pollos,
                        'Peso (lbs)': item.peso,
                        'Precio/lb': item.precio,
                        Total: item.subtotal.toFixed(2)
                    });
                });
            });
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Ventas");
            XLSX.writeFile(wb, `ventas_${new Date().toISOString().split('T')[0]}.xlsx`);
        }
        
        // ========================================
        // GESTI√ìN DE BASE DE DATOS
        // ========================================
        
        async function exportarBaseDatos() {
            try {
                const lotes = await obtenerTodos('lotes');
                const clientes = await obtenerTodos('clientes');
                const proveedores = await obtenerTodos('proveedores');
                const ventas = await obtenerTodos('ventas');
                const salidas = await obtenerTodos('salidas');
                
                const backup = {
                    version: 3,
                    fecha: new Date().toISOString(),
                    datos: {
                        lotes,
                        clientes,
                        proveedores,
                        ventas,
                        salidas
                    }
                };
                
                const dataStr = JSON.stringify(backup, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `backup_granja_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                mostrarAlerta('Backup descargado exitosamente', 'success');
            } catch (error) {
                console.error('Error al exportar:', error);
                mostrarAlerta('Error al crear el backup', 'error');
            }
        }
        
        async function importarBaseDatos(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!confirm('¬øEst√° seguro? Esto reemplazar√° todos los datos actuales con los del backup.')) {
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    
                    // Limpiar stores
                    await limpiarStore('lotes');
                    await limpiarStore('clientes');
                    await limpiarStore('proveedores');
                    await limpiarStore('ventas');
                    await limpiarStore('salidas');
                    
                    // Restaurar datos
                    for (const lote of backup.datos.lotes) {
                        await agregarRegistro('lotes', lote);
                    }
                    for (const cliente of backup.datos.clientes) {
                        await agregarRegistro('clientes', cliente);
                    }
                    if (backup.datos.proveedores) {
                        for (const proveedor of backup.datos.proveedores) {
                            await agregarRegistro('proveedores', proveedor);
                        }
                    }
                    for (const venta of backup.datos.ventas) {
                        await agregarRegistro('ventas', venta);
                    }
                    if (backup.datos.salidas) {
                        for (const salida of backup.datos.salidas) {
                            await agregarRegistro('salidas', salida);
                        }
                    }
                    
                    mostrarAlerta('Base de datos restaurada exitosamente', 'success');
                    await actualizarUI();
                } catch (error) {
                    console.error('Error al importar:', error);
                    alert('Error al restaurar el backup. Verifique que el archivo sea v√°lido.');
                }
            };
            reader.readAsText(file);
        }
        
        async function limpiarBaseDatos() {
            if (!confirm('‚ö†Ô∏è ¬øEST√Å SEGURO? Esta acci√≥n eliminar√° PERMANENTEMENTE todos los lotes, clientes, proveedores, ventas y salidas.')) {
                return;
            }
            
            if (!confirm('Esta es su √∫ltima oportunidad. ¬øDesea continuar?')) {
                return;
            }
            
            try {
                await limpiarStore('lotes');
                await limpiarStore('clientes');
                await limpiarStore('proveedores');
                await limpiarStore('ventas');
                await limpiarStore('salidas');
                
                carrito = [];
                
                mostrarAlerta('Base de datos limpiada completamente', 'success');
                await actualizarUI();
            } catch (error) {
                console.error('Error al limpiar:', error);
                mostrarAlerta('Error al limpiar la base de datos', 'error');
            }
        }
        
        async function actualizarEstadisticasDB() {
            const lotes = await obtenerTodos('lotes');
            const clientes = await obtenerTodos('clientes');
            const proveedores = await obtenerTodos('proveedores');
            const ventas = await obtenerTodos('ventas');
            const salidas = await obtenerTodos('salidas');
            
            document.getElementById('dbLotesCount').textContent = lotes.length;
            document.getElementById('dbClientesCount').textContent = clientes.length;
            document.getElementById('dbProveedoresCount').textContent = proveedores.length;
            document.getElementById('dbVentasCount').textContent = ventas.length;
            document.getElementById('dbSalidasCount').textContent = salidas.length;
            
            mostrarAlerta('Estad√≠sticas actualizadas', 'success');
        }
        
        // ========================================
        // UTILIDADES
        // ========================================
        
        function switchTab(event, tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'database') {
                actualizarEstadisticasDB();
            }
        }
        
        function mostrarAlerta(mensaje, tipo) {
            const alerta = document.createElement('div');
            alerta.className = `alert alert-${tipo}`;
            alerta.textContent = mensaje;
            
            document.querySelector('.container').insertBefore(
                alerta,
                document.querySelector('.tabs')
            );
            
            setTimeout(() => alerta.remove(), 3000);
        }
        
        async function actualizarUI() {
            await renderizarLotes();
            await renderizarClientes();
            await renderizarProveedores();
            renderizarCarrito();
            await renderizarReportes();
            await renderizarSalidas();
        }
        
        // ========================================
        // INICIALIZACI√ìN
        // ========================================
        
        document.getElementById('loteFecha').valueAsDate = new Date();
        document.getElementById('salidaFecha').valueAsDate = new Date();
        document.getElementById('ventaCantidad').value = '0';
        
        initDB().then(async () => {
            console.log('Firebase inicializado correctamente');
            // La UI se actualiza autom√°ticamente en el listener de autenticaci√≥n
        }).catch(error => {
            console.error('Error al inicializar Firebase:', error);
            alert('Error al iniciar la base de datos. Recargue la p√°gina.');
        });

        
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js')
    .then(() => console.log('Service Worker registrado'))
    .catch(err => console.error('SW error', err));
}

    </script>
</body>
</html>